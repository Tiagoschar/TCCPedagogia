<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listagem de Pacientes ‚Äî Admin</title>

  <link rel="stylesheet" href="../main.css">
  <link rel="icon" type="image/x-icon" href="Assets/Logo.jpg">

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body>
  <div class="admin-layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h2>Admin</h2>
      <nav>
        <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
        <a href="pacientes.html" class="nav-link">üë• Pacientes</a>
        <a href="consultas.html" class="nav-link">üóì Agenda</a>
        <a href="config.html" class="nav-link">‚öô Configura√ß√µes</a>
      </nav>
    </aside>

    <!-- CONTE√öDO PRINCIPAL -->
    <main class="container">
      <h1>Pacientes</h1>
      <p class="muted">Gerencie sua lista de pacientes cadastrados.</p>

      <!-- Barra de a√ß√µes -->
      <div class="mt-3">
        <button id="novoPacienteBtn" class="btn btn-primary">‚ûï Novo Paciente</button>
        <input id="searchInput" type="search" class="input" placeholder="Buscar paciente..."
          style="max-width: 260px; margin-left:12px">
      </div>

      <!-- Tabela de pacientes -->
      <div class="table-responsive mt-3 panel">
        <table class="table" id="pacientesTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Idade</th>
              <th>Respons√°vel</th>
              <th>Contato</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="pacientesBody">
            <tr>
              <td colspan="6" style="text-align: center;">Carregando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Modal de Novo Paciente -->
  <div id="novoPacienteModal" class="modal">
    <div class="modal-content panel">
      <h2>Adicionar Novo Paciente</h2>
      <form id="novoPacienteForm" class="form">
        <label>Nome completo:</label>
        <input type="text" id="nome" class="input" required>

        <label>Idade:</label>
        <input type="number" id="idade" class="input" required>

        <label>Respons√°vel:</label>
        <input type="text" id="responsavel" class="input">

        <label>Contato:</label>
        <input type="text" id="contato" class="input" required>

        <label>Status:</label>
        <select id="status" class="input">
          <option value="Ativo">Ativo</option>
          <option value="Inativo">Inativo</option>
        </select>

        <div class="mt-3">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <button type="button" id="closeModal" class="btn btn-ghost">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Importando Firebase (modular SDK)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDoc,
      getDocs,
      onSnapshot,
      query,
      orderBy,
      doc,
      deleteDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      // Refer√™ncias aos elementos DOM
      const pacientesBody = document.getElementById("pacientesBody");
      const searchInput = document.getElementById("searchInput");
      const novoPacienteBtn = document.getElementById("novoPacienteBtn");
      const novoPacienteModal = document.getElementById("novoPacienteModal");
      const closeModal = document.getElementById("closeModal");
      const novoPacienteForm = document.getElementById("novoPacienteForm");

      // Inicializa o Firestore
      const firebaseConfig = {
        apiKey: "AIzaSyDvMSEl-3Tj5IvC5cs09DY8xZuUve4NyOU",
        authDomain: "tccneuropsicopedagoga.firebaseapp.com",
        projectId: "tccneuropsicopedagoga",
        storageBucket: "tccneuropsicopedagoga.firebasestorage.app",
        messagingSenderId: "189432898003",
        appId: "1:189432898003:web:aab9ddd5eba744a6350f26",
        measurementId: "G-XR0LJT1KB8"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let currentPacienteId = null; // Vari√°vel para armazenar o ID do paciente em edi√ß√£o

      // Fun√ß√£o para renderizar pacientes
      function renderPacientes(pacientes) {
        pacientesBody.innerHTML = "";

        if (pacientes.length === 0) {
          pacientesBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Nenhum paciente encontrado</td></tr>`;
          return;
        }

        pacientes.forEach(doc => {
          const p = doc.data();
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${p.nome || "-"}</td>
            <td>${p.idade || "-"}</td>
            <td>${p.responsavel || "-"}</td>
            <td>${p.contato || "-"}</td>
            <td><span class="badge" style="background: ${p.status === "Ativo" ? "var(--primary)" : "var(--muted)"}">
                ${p.status || "Desconhecido"}
            </span></td>
            <td>
              <button data-id="${doc.id}" class="btn btn-ghost editar-btn">‚úè Editar</button>
              <button data-id="${doc.id}" class="btn btn-ghost excluir-btn" style="color: var(--danger)">üóë Excluir</button>
            </td>
          `;
          pacientesBody.appendChild(tr);
        });

        // Adicionar evento de editar
        const editarBtns = document.querySelectorAll(".editar-btn");
        editarBtns.forEach(btn => {
          btn.addEventListener("click", (e) => {
            const pacienteId = e.target.dataset.id;
            abrirModalEdicao(pacienteId);  // Chama a fun√ß√£o para preencher o modal com os dados
          });
        });

        // Adicionar evento de excluir
        const excluirBtns = document.querySelectorAll(".excluir-btn");
        excluirBtns.forEach(btn => {
          btn.addEventListener("click", (e) => {
            const pacienteId = e.target.dataset.id;
            excluirPaciente(pacienteId);  // Chama a fun√ß√£o para excluir o paciente
          });
        });
      }

      // Fun√ß√£o para excluir paciente
      window.excluirPaciente = async function excluirPaciente(pacienteId) { // Tornando a fun√ß√£o global
        const pacienteRef = doc(db, "pacientes", pacienteId);  // Refer√™ncia ao documento do paciente no Firestore

        try {
          await deleteDoc(pacienteRef);  // Deletando o documento do paciente
          alert("Paciente exclu√≠do com sucesso!");
          const q = query(collection(db, "pacientes"), orderBy("nome", "asc"));
          const snapshot = await getDocs(q);  // Recarregar os pacientes
          renderPacientes(snapshot.docs);  // Atualizar a lista de pacientes
        } catch (error) {
          console.error("Erro ao excluir paciente:", error);
          alert("Erro ao excluir o paciente!");
        }
      };

      // Fun√ß√£o para abrir o modal de edi√ß√£o e preencher os dados
      async function abrirModalEdicao(pacienteId) {
        const pacienteRef = doc(db, "pacientes", pacienteId);
        const pacienteDoc = await getDoc(pacienteRef);

        if (pacienteDoc.exists()) {
          const paciente = pacienteDoc.data();

          // Preencher o formul√°rio de edi√ß√£o com os dados do paciente
          document.getElementById("nome").value = paciente.nome;
          document.getElementById("idade").value = paciente.idade;
          document.getElementById("responsavel").value = paciente.responsavel;
          document.getElementById("contato").value = paciente.contato;
          document.getElementById("status").value = paciente.status;

          // Mostrar o modal de edi√ß√£o
          novoPacienteModal.style.display = "flex";

          // Armazenar o ID do paciente em edi√ß√£o
          currentPacienteId = pacienteId;

          // Alterar o comportamento do formul√°rio para atualiza√ß√£o de paciente
          novoPacienteForm.onsubmit = async (e) => {
            e.preventDefault();  // Impede o envio padr√£o do formul√°rio

            // Se estamos editando, vamos atualizar o paciente no Firestore
            if (currentPacienteId) {
              const pacienteRef = doc(db, "pacientes", currentPacienteId);

              await updateDoc(pacienteRef, {
                nome: document.getElementById("nome").value,
                idade: parseInt(document.getElementById("idade").value),
                responsavel: document.getElementById("responsavel").value,
                contato: document.getElementById("contato").value,
                status: document.getElementById("status").value,
              });

              currentPacienteId = null;  // Limpa o ID do paciente ap√≥s a edi√ß√£o
            }

            // Ap√≥s salvar, fechar o modal e resetar o formul√°rio
            novoPacienteModal.style.display = "none";
            novoPacienteForm.reset();

            // Atualiza a lista de pacientes
            const q = query(collection(db, "pacientes"), orderBy("nome", "asc"));
            const snapshot = await getDocs(q);
            renderPacientes(snapshot.docs);
          };
        } else {
          alert("Paciente n√£o encontrado!");
        }
      }

      // Carregar pacientes em tempo real
      const q = query(collection(db, "pacientes"), orderBy("nome", "asc"));
      onSnapshot(q, snapshot => {
        renderPacientes(snapshot.docs);
      });

      // Filtro de busca
      searchInput.addEventListener("input", async (e) => {
        const search = e.target.value.toLowerCase();

        const q = query(collection(db, "pacientes"), orderBy("nome", "asc"));
        const querySnapshot = await getDocs(q);

        const filtrados = querySnapshot.docs.filter(doc =>
          doc.data().nome.toLowerCase().includes(search)
        );

        renderPacientes(filtrados);
      });

      // Abrir o modal para novo paciente
      novoPacienteBtn.addEventListener("click", () => {
        novoPacienteModal.style.display = "flex";  // Exibe o modal (ou use "block" dependendo do seu layout)
      });

      // Fechar o modal
      closeModal.addEventListener("click", () => {
        novoPacienteModal.style.display = "none"; // Esconde o modal
      });

      // Submeter formul√°rio de novo paciente
      novoPacienteForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Se o paciente estiver sendo editado, atualiza a informa√ß√£o no Firestore
        if (currentPacienteId) {
          const pacienteRef = doc(db, "pacientes", currentPacienteId);

          await updateDoc(pacienteRef, {
            nome: document.getElementById("nome").value,
            idade: parseInt(document.getElementById("idade").value),
            responsavel: document.getElementById("responsavel").value,
            contato: document.getElementById("contato").value,
            status: document.getElementById("status").value,
          });

          currentPacienteId = null;  // Limpa o ID do paciente ap√≥s a edi√ß√£o
        } else {
          // Caso contr√°rio, cria um novo paciente
          await addDoc(collection(db, "pacientes"), {
            nome: document.getElementById("nome").value,
            idade: parseInt(document.getElementById("idade").value),
            responsavel: document.getElementById("responsavel").value,
            contato: document.getElementById("contato").value,
            status: document.getElementById("status").value,
          });
        }

        // Ap√≥s salvar, fecha o modal e limpa o formul√°rio
        novoPacienteModal.style.display = "none"; // Esconde o modal
        novoPacienteForm.reset();

        // Atualiza a lista de pacientes
        const q = query(collection(db, "pacientes"), orderBy("nome", "asc"));
        const snapshot = await getDocs(q);
        renderPacientes(snapshot.docs);
      });
    });
</script>
</body>

</html>
