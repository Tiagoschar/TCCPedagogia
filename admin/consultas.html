<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda ‚Äî Admin</title>

  <link rel="stylesheet" href="../main.css">
  <style>
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 16px;
    }

    .day {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px;
      min-height: 110px;
      cursor: pointer;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      font-size: 14px;
    }

    .day:hover {
      background: var(--bg);
    }

    .day.today {
      border: 2px solid var(--primary);
    }

    .day-number {
      font-weight: bold;
      margin-bottom: 6px;
    }

    .events {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .event {
      background: var(--primary);
      color: white;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      max-width: 400px;
      width: 100%;
    }

    .event-actions {
      display: flex;
      gap: 6px;
      margin-left: 6px;
    }
  </style>
</head>

<body>
  <div class="admin-layout">
    <aside class="sidebar">
      <h2>Admin</h2>
      <nav>
        <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
        <a href="pacientes.html" class="nav-link">üë• Pacientes</a>
        <a href="agenda.html" class="nav-link">üóì Agenda</a>
        <a href="config.html" class="nav-link">‚öô Configura√ß√µes</a>
      </nav>
    </aside>

    <main class="container">
      <h1>Agenda</h1>
      <p class="muted">Visualize, edite e adicione consultas.</p>

      <div class="calendar-header mt-3">
        <button id="prevMonth" class="btn btn-ghost">‚¨Ö M√™s anterior</button>
        <h2 id="monthYear"></h2>
        <button id="nextMonth" class="btn btn-ghost">M√™s seguinte ‚û°</button>
      </div>

      <div class="calendar mt-3" id="calendar"></div>
    </main>
  </div>

  <!-- MODAL -->
  <div class="modal" id="eventModal">
    <div class="modal-content panel">
      <h2 id="modalDate"></h2>
      <ul id="eventList"></ul>

      <h3 class="mt-3">‚ûï Nova Consulta</h3>
      <form id="eventForm">
        <input type="text" id="paciente" class="input mt-1" placeholder="Nome do paciente" required>
        <input type="time" id="hora" class="input mt-1" required>
        <button type="submit" class="btn btn-primary mt-2">Salvar</button>
      </form>
      <button id="closeModal" class="btn btn-ghost mt-2">Fechar</button>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const calendar = document.getElementById("calendar");
    const monthYear = document.getElementById("monthYear");
    const modal = document.getElementById("eventModal");
    const modalDate = document.getElementById("modalDate");
    const eventList = document.getElementById("eventList");
    const eventForm = document.getElementById("eventForm");
    const pacienteInput = document.getElementById("paciente");
    const horaInput = document.getElementById("hora");

    let currentDate = new Date();
    let selectedDate = null;

    function formatDate(year, month, day) {
      return `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      let firstDay = new Date(Date.UTC(year, month, 1)).getUTCDay();
      if (firstDay === 0) firstDay = 7;

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      monthYear.textContent = currentDate.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });

      calendar.innerHTML = "";

      for (let i = 1; i < firstDay; i++) {
        calendar.innerHTML += `<div></div>`;
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const fullDate = formatDate(year, month, d);
        const today = new Date().toISOString().split("T")[0] === fullDate;

        const div = document.createElement("div");
        div.classList.add("day");
        if (today) div.classList.add("today");
        div.dataset.date = fullDate;
        div.innerHTML = `<div class="day-number">${d}</div><div class="events"></div>`;

        div.addEventListener("click", () => openModal(fullDate));
        calendar.appendChild(div);

        loadEvents(fullDate, div.querySelector(".events"));
      }
    }

    function openModal(date) {
      selectedDate = date;
      modal.classList.add("active");
      modalDate.textContent = new Date(date + "T00:00:00").toLocaleDateString("pt-BR");
      loadEvents(date, eventList, true);
    }

    function closeModal() {
      modal.classList.remove("active");
      eventList.innerHTML = "";
      eventForm.reset();
    }

    function loadEvents(date, container, detailed = false) {
      container.innerHTML = "";
      const q = query(collection(db, "consultas"), where("data", "==", date));
      onSnapshot(q, snapshot => {
        container.innerHTML = "";
        if (snapshot.empty && detailed) {
          container.innerHTML = `<li class="muted">Nenhuma consulta</li>`;
        }
        snapshot.forEach(docSnap => {
          const c = docSnap.data();
          if (detailed) {
            container.innerHTML += `
              <li>
                ${c.hora} - ${c.paciente}
                <span class="event-actions">
                  <button class="btn btn-ghost" data-edit="${docSnap.id}" data-hora="${c.hora}" data-paciente="${c.paciente}">‚úè</button>
                  <button class="btn btn-ghost" data-del="${docSnap.id}">üóë</button>
                </span>
              </li>`;
          } else {
            const div = document.createElement("div");
            div.classList.add("event");
            div.textContent = `${c.hora} ${c.paciente}`;
            container.appendChild(div);
          }
        });

        if (detailed) {
          container.querySelectorAll("button[data-edit]").forEach(btn => {
            btn.addEventListener("click", async e => {
              const id = e.target.dataset.edit;
              const pacienteAtual = e.target.dataset.paciente;
              const horaAtual = e.target.dataset.hora;

              const novoPaciente = prompt("Nome do paciente:", pacienteAtual);
              const novaHora = prompt("Hora:", horaAtual);

              if (novoPaciente && novaHora) {
                await updateDoc(doc(db, "consultas", id), {
                  paciente: novoPaciente,
                  hora: novaHora
                });
              }
            });
          });

          container.querySelectorAll("button[data-del]").forEach(btn => {
            btn.addEventListener("click", async e => {
              const id = e.target.dataset.del;
              if (confirm("Excluir esta consulta?")) {
                await deleteDoc(doc(db, "consultas", id));
              }
            });
          });
        }
      });
    }

    document.getElementById("prevMonth").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });
    document.getElementById("nextMonth").addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });
    document.getElementById("closeModal").addEventListener("click", closeModal);

    eventForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!selectedDate) return;

      await addDoc(collection(db, "consultas"), {
        paciente: pacienteInput.value,
        hora: horaInput.value,
        data: selectedDate
      });
      eventForm.reset();
    });

    renderCalendar();
  </script>
</body>

</html>
